
module.exports = function(req) {
//	  req.app.db.models.Account ,req.user.roles.account.integral;
function Integral(){
}

/**
 * 总添加
 */
Integral.prototype.add = function(addMomey ,callback){
	//获取活动方案
	var conditions = {
			isUse :'yes',
	};
	req.app.db.models.Integral.findOne(conditions , function(err ,integral){
		if(err){
			callback(err);
		}
		if(integral){
			//计算积分
			var PointsPercent = eval('integral.PointsPercentOfLeve.lv'+req.user.roles.account.integral.level);
			req.user.roles.account.integral.points += PointsPercent.percent * addMomey;
			//添加金额
			req.user.roles.account.integral.consumeMoney += addMomey;
			//计算等级
				//当前等级下是否还有等级
			var level = req.user.roles.account.integral.level;
			while(true){
				PointsPercent = eval('integral.PointsPercentOfLeve.lv' + level);
				
				if( PointsPercent && ( req.user.roles.account.integral.consumeMoney >= PointsPercent.consumeMoney ) ){
					req.user.roles.account.integral.level = level;
					req.user.roles.account.integral.levelName = PointsPercent.leveName ;
				}else{
					break;
				}
				level++;
			}
			//更新
			//设置方式
			var fieldsToSet = {
					'integral.consumeMoney' : req.user.roles.account.integral.consumeMoney,
					'integral.points' : req.user.roles.account.integral.points,
					'integral.levelName' : req.user.roles.account.integral.levelName,
					'integral.level' : req.user.roles.account.integral.level,
					'integral.coin' : req.user.roles.account.integral.coin,
			};
			req.app.db.models.Account.findByIdAndUpdate(req.user.roles.account.id ,fieldsToSet ,function(err ,queryObj){
				if(err){
					callback(err);
				}
				if(queryObj){
					callback(null ,queryObj);
				}
			});
		}
		else{
			callback('err : Can\'t find integral');
		}
	});
};
/**
 * 金额
 */

/**
 * 等级
 */

/**
 * 积分
 */

/**
 * 金币
 */

return Integral;
};
//module.exports = Integral;